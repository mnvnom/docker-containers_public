pipeline {
    agent any

    stages {
        stage('yaml-lint') {
            steps {
                script {
                    def lintResult = sh(script: 'yamllint $(find . -name "*.yml" -o -name "*.yaml" )', returnStatus: true)
                    if (lintResult != 0) {
                        error "YAML linting failed"
                    }
                }
            }
        }

        stage('Deploy Conteiners') {
            steps {
                script {
                    def deployCmd = 'ansible-playbook playbooks/all_containers.yml -i inventory/inventory.yml --tags=run_all_containers'
                    def deployResult = sh(script: deployCmd, returnStatus: true)
                    if (deployResult != 0) {
                        error "Failed to deploy containers"
                    }
                }
            }
        }

        stage('Check Conteiners') {
            steps {
                script {
                    def containers = sh(script: 'docker ps -q', returnStdout: true).trim().split('\n')
                    for (container in containers) {
                        def status = sh(script: "docker inspect --format='{{.State.Status}}' ${container}", returnStdout: true).trim()
                        if (status != 'running') {
                            error "Container ${container} is not running"
                        }
                    }
                }
            }
        }
    }

//     post {
//         always {
//             sh 'docker stop $(docker ps -q -a) && docker rm $(docker ps -q -a)'
//         }
//     }
// }